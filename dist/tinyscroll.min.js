!function(a,b){"function"==typeof defien&&define.amd?define(["jquery"],function(a){return b()}):"undefined"!=typeof module&&module.exports?module.exports=b():window[a]=b()}("TinyScroll",function(){"use strict";function a(a){this.options=$.extend({},a),this.$wrapper=$(this.options.wrapper),this.$target=null,this.targetTop=0,this.targetHeight=0,this.childHeight=b,this.freezing=!1,this.moving=!1,this.curTopMap={},this.oriTopMap={},this.touchTime=0,this.touchY=0,this.timeGap=0,this.moveState="down",this.mTopLocked=!1,this.mBottomLocked=!1,this.dTopLocked=!1,this.dBottomLocked=!1,this.stateTree={year:this.options.year||1e4,month:this.options.month||1e4,day:this.options.day||1e4},this.stateCache={year:this.options.year||1e4,month:this.options.month||1e4,day:this.options.day||1e4},this.fnList={year:this.yearChanged,month:this.monthChanged,day:this.dayChanged},this.init();var c=this;setTimeout(function(a){var b=new Date(c.options.initDate);c.setState({year:b.getFullYear(),month:b.getMonth()+1,day:b.getDate()}),$.extend(c.stateCache,c.stateTree)},300)}var b=30;return a.prototype={constructor:a,init:function(){if(new Date(this.options.initDate)<new Date(this.options.range[0])||new Date(this.options.initDate)>new Date(this.options.range[1]))throw"Error: the initDate is ERROR!";this.render()},render:function(){var a=this;this.diffState(a.stateCache,a.stateTree);if(0!==this.$wrapper.children().length)return this.$wrapper.find(".tiny-scroll-backdrop").show(),void this.$wrapper.find(".tiny-scroll").removeClass("slideOutDown").addClass("slideInUp");var b=['<div class="tiny-scroll-backdrop"></div>','<div class="tiny-scroll slideInUp animated">',this.options.title?'<div class="ts-header">'+this.options.title+"</div>":"",'<div class="ts-body">','<div class="ts-mask"></div>','<div class="ts-front"></div>','<div class="ts-col">',this.options.needLabel?"<em>年</em>":"",'<ul id="year" class="ts-item-list" data-target="year">'+this.generateList("year")+"</ul>","</div>",'<div class="ts-col">',this.options.needLabel?"<em>月</em>":"",'<ul id="month" class="ts-item-list" data-target="month">'+this.generateList("month")+"</ul>","</div>",'<div class="ts-col">',this.options.needLabel?"<em>日</em>":"",'<ul id="day" class="ts-item-list" data-target="day">'+this.generateList("day")+"</ul>","</div>","</div>",'<div class="ts-footer">','<div class="btns-wrapper">','<span class="ts-cancel-btn">'+(this.options.cancelValue?this.options.cancelValue:"Cancel")+"</span>",'<span class="ts-ok-btn">'+(this.options.okValue?this.options.okValue:"OK")+"</span>","</div>","</div>","</div>"].join("");this.$wrapper.append(b),this.eventBinding()},show:function(){this.render()},hide:function(){var a=this;this.setState(a.stateCache),this.$wrapper.find(".tiny-scroll").removeClass("slideInUp").addClass("slideOutDown"),this.$wrapper.find(".tiny-scroll-backdrop").hide()},getMinDate:function(){var a=this;return new Date(a.options.range[0])},getMaxDate:function(){var a=this;return new Date(a.options.range[1])},getInitDate:function(){var a=this;return new Date(a.options.initDate)},getMonthDays:function(a,b){var c=a%4===0&&(a%100!==0||a%400===0),d=[31,28,31,30,31,30,31,31,30,31,30,31],e=[31,29,31,30,31,30,31,31,30,31,30,31];return c?e[b]:d[b]},formatDate:function(a,b,c){return a=parseInt(a||this.stateTree.year),b=parseInt(b||this.stateTree.month),c=parseInt(c||this.stateTree.day),a+"-"+(b>9?b:"0"+b)+"-"+(c>9?c:"0"+c)},generateList:function(a){var b=this.getMinDate(),c=this.getMaxDate(),d=this.getInitDate(),e="";if("year"==a)for(var f=parseInt(c.getFullYear()),g=parseInt(b.getFullYear()),h=0;f-g>=h;h++)e+='<li data-index="'+(g+h)+'">'+(g+h)+"</li>";else if("month"==a)for(var i=1;12>=i;i++)e+='<li data-index="'+i+'">'+i+"</li>";else if("day"==a)for(var j=1;j<this.getMonthDays(d.getFullYear(),d.getMonth())+1;j++)e+='<li data-index="'+j+'">'+j+"</li>";return e},setState:function(a){for(var b in a)this.stateTree[b]&&a[b]!==this.stateTree[b]&&(this.stateTree[b]=a[b],this.fnList[b].call(this),this.mTopLocked&&a[b]<this.stateTree[b]&&console.info("Month top has locked! Do not move!"),this.dTopLocked&&a[b]<this.stateTree[b]&&console.info("Day top has locked! Do not move!"),this.mBottomLocked&&a[b]>this.stateTree[b]&&console.info("Month bottom has locked! Do not move!"),this.dBottomLocked&&a[b]>this.stateTree[b]&&console.info("Day bottom has locked! Do not move!"))},diffState:function(a,b){var c=!0;for(var d in a)if(a[d]!=b[d]){c=!1;break}return c},highlightSelected:function(a){var b=this.$wrapper.find("#"+a);b.find(".selected").removeClass("selected"),b.find('li[data-index="'+this.stateTree[a]+'"]').addClass("selected")},yearChanged:function(a){console.log("year change to : "+this.stateTree.year),this.indexTransPos(a,$(document.body).find("#year"),this.stateTree.year),this.monthListFix(),this.dayListFix(),this.highlightSelected("year")},monthChanged:function(a){console.log("month changed to : "+this.stateTree.month),this.indexTransPos(a,$(document.body).find("#month"),this.stateTree.month),this.monthListFix(),this.dayListFix(),this.highlightSelected("month")},dayChanged:function(a){console.log("day changed to : "+this.stateTree.day),this.indexTransPos(a,$(document.body).find("#day"),this.stateTree.day),this.dayListFix(),this.highlightSelected("day")},monthListFix:function(){var a=(this.$wrapper.find("#month"),this.getMaxDate()),b=this.getMinDate(),c=b.getMonth();if(this.stateTree.year==b.getFullYear())console.log("reach min year"),this.disablePrevItems("month",c),this.stateTree.month<=c&&(this.mTopLocked=!0,this.setState({month:c+1}));else{this.enablePrevItems("month"),this.mTopLocked=!1;var d=a.getMonth();this.stateTree.year==a.getFullYear()?(console.log("reach max year"),this.disableNextItems("month",d),this.stateTree.month>d&&(this.mBottomLocked=!0,this.setState({month:d+1}))):(this.enableNextItems("month"),this.mBottomLocked=!1)}},dayListFix:function(){var a=this.$wrapper.find("#day"),b=a.children().length,c=this.getMonthDays(this.stateTree.year,this.stateTree.month-1),d=this.getMaxDate(),e=this.getMinDate(),f=e.getDate();if(this.stateTree.year==e.getFullYear()&&this.stateTree.month==e.getMonth()+1)console.log("reach min month"),this.disablePrevItems("day",f-1),this.stateTree.day<f&&(this.dTopLocked=!0,this.setState({day:f}));else{this.enablePrevItems("day"),this.dTopLocked=!1;var g=d.getDate();this.stateTree.year==d.getFullYear()&&this.stateTree.month==d.getMonth()+1?(console.log("reach max month"),this.disableNextItems("day",g-1),this.stateTree.day>g&&(this.dBottomLocked=!0,this.setState({day:g}))):(this.enableNextItems("day"),this.dBottomLocked=!1)}if(c>b)for(var h=b+1;c>=h;h++)a.append('<li data-index="'+h+'">'+h+"</li>");else if(b>c){for(var i=0;b-c>i;i++)a.children().last().remove();a.children().last().data("index")<=this.stateTree.day&&this.setState({day:a.children().last().data("index")})}},disablePrevItems:function(a,b){var c=this.$wrapper.find("#"+a);c.children(".disable").removeClass("disable"),c.children().eq(b).prevAll().addClass("disable")},disableNextItems:function(a,b){var c=this.$wrapper.find("#"+a);c.children(".disable").removeClass("disable"),c.children().eq(b).nextAll().addClass("disable")},enablePrevItems:function(a){this.$wrapper.find("#"+a).children().prevAll(".disable").removeClass("disable")},enableNextItems:function(a){this.$wrapper.find("#"+a).children().nextAll(".disable").removeClass("disable")},eventBinding:function(){var a=this;this.$wrapper.on("click",".tiny-scroll-backdrop",function(b){a.hide()}),this.$wrapper.on("touchstart touchmove touchend",".ts-item-list",function(b){switch(this.$target=$(b.target).hasClass(".ts-item-list")?$(b.target):$(b.target).parents(".ts-item-list"),b.originalEvent.type){case"touchstart":a.touchStart.call(a,b,this.$target);break;case"touchmove":a.touchMove.call(a,b,this.$target);break;case"touchend":a.touchEnd.call(a,b,this.$target)}}),this.$wrapper.on("click",".ts-cancel-btn",function(){a.setState(a.stateCache),a.hide()}),this.$wrapper.on("click",".ts-ok-btn",function(){$.extend(a.stateCache,a.stateTree),a.hide(),a.options.okCallback&&"function"==typeof a.options.okCallback&&a.options.okCallback(a.formatDate())})},touchStart:function(a){if(!this.freezing){a.stopPropagation();var b,c=$(a.target).parents(".ts-item-list");c.length&&(this.moving=!0,this.touchTime=a.timeStamp,this.curTopMap[c.data("target")]=this.curTopMap[c.data("target")]?this.curTopMap[c.data("target")]:0,b=this.getPointPos(a.originalEvent.touches[0]),this.touchY=b-this.curTopMap[c.data("target")],this.moving=!0)}},touchMove:function(a,b){if(!this.moving)return!1;a.preventDefault(),a.stopPropagation();var c=this.getPointPos(a.originalEvent.touches[0]);this.curTopMap[b.data("target")]=c-this.touchY,b.css("transform","translateY("+this.curTopMap[b.data("target")]+"px)")},touchEnd:function(a,c){if(!this.moving)return!1;a.stopPropagation(),this.freezing=!0;var d=this,e=this.curTopMap[c.data("target")],f=e%b;this.moveState=f>0?function(){return e>2*b?(d.translateYUpdate(c,2*b),void d.touchEndEvent(a,c)):void(f>b/2?(d.translateYUpdate(c,e+b-f),d.touchEndEvent(a,c)):(d.translateYUpdate(c,e-f),d.touchEndEvent(a,c)))}():function(){var g=$(a.target).parents(".ts-item-list").outerHeight()-3*d.childHeight;return Math.abs(e)>g?(d.translateYUpdate(c,-g),void d.touchEndEvent(a,c)):void(-(b/2)>f?(d.translateYUpdate(c,e-b-f),d.touchEndEvent(a,c)):(d.translateYUpdate(c,e-f),d.touchEndEvent(a,c)))}()},touchEndEvent:function(a,b){this.posTransIndex(a,this.curTopMap[b.data("target")]),this.moving=!1,this.freezing=!1},translateYUpdate:function(a,b){a.css("transform","translateY("+b+"px)"),this.curTopMap[a.data("target")]=b},posTransIndex:function(a,c){var d=$(a.target).parents(".ts-item-list"),e=d.attr("id"),f=d.find("li").eq(2-c/b).data("index");switch(e){case"year":this.setState({year:f});break;case"month":this.setState({month:f});break;case"day":this.setState({day:f})}},indexTransPos:function(a,c,d){var e=c.find('[data-index="'+parseInt(d)+'"]'),f=e.index(),g=f-2;this.translateYUpdate(c,-(b*g))},getPointPos:function(a){return Math.max(document.body.scrollTop,document.documentElement.scrollTop)+a.clientY}},a});